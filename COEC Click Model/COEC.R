library("sqldf")
a=read.csv("/home/deepak/Documents/Projects/QUL Labeling Model/posbias.csv",sep=",",header=F)
colnames(a) = c("query","position","clicks");
a$position=as.numeric(trim(a$position));
b=sqldf("select trim(query) as query,trim(position) as position,sum(ifnull(clicks,0)) as clicks from a group by trim(query),trim(position)")
total=sqldf("select sum(clicks) from b");
b$position=as.numeric(b$position);
index=sqldf(paste("select position,sum(ifnull(clicks,0))*1.00/",total," as wt from b group by 1 order by position asc",sep=""))
q="nike";
tot=sqldf(paste("select sum(clicks) from b where query = '",q,"'",sep=""));
sqldf(paste("select position,clicks,clicks*1.00/",tot," from b where query = '",q,"' order by position asc limit 15",sep=""));
index1= index[2:nrow(index),];
getDist = function(query)
{
  q=query;
  tot=sqldf(paste("select sum(clicks) from b where query = '",q,"'",sep=""));
  #sqldf(paste("select position,clicks,clicks*1.00/",tot," from b where query = '",q,"' order by position asc limit 15",sep=""));
  sqldf(paste("select a.position,clicks,wt,clicks*1.00/",tot,", ((clicks*1.00/",tot,") - wt)*",tot," as delta from b a,index1 b where a.position = b.position and query = '",q,"' order by a.position asc limit 20",sep=""));
}

topq=sqldf("select query,sum(clicks) as clk from b group by 1 order by sum(clicks) desc limit 500");


#NDCG in R
ndcg <- function(x) {
  # x is a vector of relevance scores
  ideal_x <- rev(sort(x))
  DCG <- function(y) y[1] + sum(y[-1]/log(2:length(y), base = 2))
  DCG(x)/DCG(ideal_x)
}

aa=as.vector(getDist("16 gb pen drives")$delta)
ndcg(a)

id,noOfRatings,avgRating,pogQualityScore,Price,discount
258047,707,4.4,0.5,817.0,10.0
258041,1319,4.3,0.5,1539.0,16.0
654306209194,3,4.0,0.5,872.0,0.0
10034015,517,4.4,0.5,1326.0,11.0
258027,200,4.3,0.5,1539.0,16.0
641007850442,1,5.0,0.5,499.0,75.0
467252927,343,4.2,0.5,1029.0,15.0
685198724675,39,4.8,0.5,949.0,4.0
132275939,178,4.2,0.5,1659.0,10.0
114103607,133,4.3,0.5,1220.0,0.0
620632411080,9,3.4,0.5,1499.0,0.0
648853369298,11,3.3,0.5,597.0,40.0
673756170691,11,3.6,0.5,790.0,36.0
630136454980,2,2.5,0.5,885.0,0.0
1536005623,13,3.4,0.5,865.0,0.0
66731260,63,4.3,0.5,920.0,0.0
642383215795,0,0.0,0.5,1599.0,0.0
331072671,57,4.6,0.5,919.0,0.0
1236851778,4,4.3,0.5,3500.0,22.0
258044,44,4.4,0.5,926.0,0.0
651250409735,1,1.0,0.5,790.0,36.0
630362430125,2,4.0,0.5,1043.0,0.0
632183395546,2,5.0,0.5,499.0,0.0
1541494594,91,4.4,0.5,1100.0,0.0
621199688615,4,3.3,0.5,915.0,0.0
294426494,40,4.5,0.5,1690.0,0.0
1319874719,0,0.0,0.5,4950.0,4.0
622539568091,9,3.2,0.5,597.0,40.0
938553192,0,0.0,0.5,835.0,0.0
622615573814,2,3.5,0.5,590.0,43.0
666203977742,9,4.2,0.5,915.0,0.0
527487,146,4.3,0.5,908.0,0.0
624196051242,4,3.5,0.5,895.0,0.0
654219764466,3,4.3,0.5,590.0,43.0
352199086,13,3.6,0.5,1087.0,63.0
200578047,4,4.8,0.5,3198.0,23.0
669815676819,1,5.0,0.5,629.0,16.0
2059686333,6,4.5,0.5,1200.0,0.0
672116239640,1,4.0,0.5,590.0,43.0
652905276255,15,4.4,0.5,695.0,0.0
1627283659,42,4.1,0.5,1028.0,0.0
663046978940,0,0.0,0.5,2000.0,4.0
632088025025,0,0.0,0.5,650.0,23.0
632722549785,0,0.0,0.5,908.0,0.0
680137207270,2,5.0,0.5,872.0,11.0
631186090232,0,0.0,0.5,369.0,47.0
1636237062,59,4.0,0.5,949.0,12.0
767899826,10,4.5,0.5,875.0,0.0
668903258052,0,0.0,0.5,590.0,43.0
681491544711,0,0.0,0.5,509.0,3.0
1088483089,31,3.9,0.5,159.0,46.0
621139524974,0,0.0,,299.0,25.0
621668781145,0,0.0,,299.0,25.0
618794344260,0,0.0,,299.0,25.0
622065176668,0,0.0,,299.0,25.0
620955024006,0,0.0,,299.0,25.0
620513483231,0,0.0,,299.0,25.0
622445186020,0,0.0,0.5,199.0,50.0
400883849,2,1.0,0.5,429.0,52.0
682763073553,0,0.0,0.5,242.0,46.0
663255300985,0,0.0,0.5,1499.0,21.0
677126949186,0,0.0,0.5,1469.0,22.0
680493307793,0,0.0,0.5,1469.0,22.0
629389217709,0,0.0,0.5,1469.0,22.0
626695439491,0,0.0,0.5,431.0,52.0
648188015126,0,0.0,0.5,1499.0,21.0
648170613407,0,0.0,0.5,1499.0,21.0
630655078385,0,0.0,0.5,650.0,23.0
653388491269,0,0.0,0.5,1499.0,21.0
632617538020,0,0.0,0.5,1499.0,21.0
648560878132,0,0.0,0.5,1499.0,21.0
645122051605,0,0.0,0.5,1499.0,21.0
659283566340,0,0.0,0.5,1499.0,21.0
654152886904,0,0.0,0.5,1499.0,21.0
639099602126,0,0.0,0.5,176.0,64.0
635156369034,0,0.0,0.5,1469.0,22.0
637423103499,0,0.0,0.5,1469.0,22.0
646243249333,0,0.0,0.5,1469.0,22.0
622598529962,1,1.0,0.5,350.0,41.0
635025585319,0,0.0,0.5,204.0,48.0
669821171031,0,0.0,0.5,1561.0,30.0
678655529022,0,0.0,0.5,619.0,58.0
626137385494,0,0.0,0.5,243.0,51.0
621812033522,0,0.0,0.5,204.0,59.0
318013081,8,2.6,0.5,204.0,59.0
625197045134,0,0.0,0.5,243.0,51.0
615324006,10,3.9,0.5,165.0,66.0
621011424394,0,0.0,0.5,472.0,28.0
644394473082,0,0.0,0.5,1231.0,36.0
1270067915,5,4.4,0.5,1999.0,9.0
682260292402,0,0.0,0.5,799.0,0.0
651581459017,0,0.0,0.5,4950.0,4.0
651188277367,0,0.0,0.5,899.0,0.0
619092900549,0,0.0,0.5,4200.0,15.0
258043,4,3.5,0.5,834.0,0.0
932500894,2,4.0,0.5,1100.0,6.0
685499428755,0,0.0,0.5,1028.0,0.0
2091066165,30,4.1,0.5,6570.0,12.0
837437579,127,4.5,0.5,1932.0,7.0
662996356362,0,0.0,0.5,750.0,40.0
621236523188,0,0.0,0.5,1599.0,0.0
639731581393,0,0.0,0.5,2550.0,36.0
655244942645,0,0.0,0.5,1499.0,18.0
1861468202,0,0.0,0.5,4950.0,4.0
659120755389,0,0.0,0.5,1079.0,0.0
646113722941,0,0.0,0.5,830.0,16.0
648349958211,0,0.0,0.5,4950.0,10.0
632797048151,0,0.0,0.5,1513.0,12.0
666752968076,2,5.0,0.5,799.0,11.0
637458323800,0,0.0,0.5,2900.0,0.0
666305948727,0,0.0,0.5,815.0,64.0
632108911162,0,0.0,0.5,1341.0,13.0
649577394948,0,0.0,0.5,925.0,0.0
668292301009,0,0.0,0.5,499.0,61.0
656614697160,0,0.0,0.5,1449.0,0.0
647382614476,0,0.0,0.5,849.0,15.0
670270822076,0,0.0,0.5,500.0,0.0
623694651087,0,0.0,0.5,1224.0,36.0
676408586957,0,0.0,0.5,4950.0,10.0
659308321766,0,0.0,0.5,849.0,15.0
654122355084,0,0.0,0.5,1449.0,0.0
666677013177,0,0.0,0.5,4803.0,12.0
636927715954,0,0.0,0.5,590.0,43.0
622113344488,0,0.0,0.5,1488.0,10.0
648370560633,1,2.0,0.5,899.0,0.0
1101986588,0,0.0,0.5,993.0,50.0
1691011728,4,3.5,0.5,1061.0,9.0
672207884453,0,0.0,0.5,2999.0,14.0
651159228733,2,3.0,0.5,899.0,0.0
619587328993,0,0.0,0.5,3799.0,24.0
113601133,0,0.0,0.5,993.0,50.0
645502325653,0,0.0,0.5,1233.0,42.0
672675788375,0,0.0,0.5,730.0,1.0
527510,9,4.3,0.5,890.0,0.0
648516966555,0,0.0,0.5,1750.0,0.0
243982975,2,3.0,0.5,920.0,0.0
1000481560,0,0.0,0.5,993.0,50.0
646788918340,0,0.0,0.5,1231.0,36.0
666248955665,0,0.0,0.5,745.0,25.0
668698203020,0,0.0,0.5,2499.0,0.0
1133007100,1,4.0,0.5,2206.0,50.0
621852836284,1,5.0,0.5,1019.0,0.0
871209894,381,4.1,0.5,805.0,7.0
1519478154,0,0.0,0.5,993.0,50.0
258042,16,4.2,0.5,750.0,10.0
1085321057,1,4.0,0.5,990.0,0.0
620558610052,0,0.0,0.5,7500.0,0.0
258037,45,4.2,0.5,926.0,0.0
702693557,31,4.4,0.5,1214.0,0.0
1521582197,59,4.1,0.5,1049.0,0.0
1720554732,4,4.3,0.5,499.0,50.0
1016201481,29,4.6,0.5,1499.0,31.0
293900381,581,4.3,0.5,1350.0,0.0
652713018401,0,0.0,0.5,849.0,15.0
527536,23,3.9,0.5,890.0,0.0
653525794346,0,0.0,0.5,1449.0,0.0
668194239421,0,0.0,0.5,770.0,0.0
655642590516,9,3.2,0.5,890.0,0.0
654664684216,1,5.0,0.5,1900.0,11.0
648190243078,0,0.0,0.5,744.0,25.0
654080524299,1,5.0,0.5,500.0,1.0
659106429836,0,0.0,0.5,850.0,14.0
625711140550,0,0.0,0.5,1164.0,17.0
672222380751,4,4.5,0.5,1500.0,0.0
673992487064,0,0.0,0.5,1049.0,0.0
851166178,8,4.0,0.5,4950.0,4.0
621748207657,0,0.0,0.5,2269.0,0.0
648613045232,0,0.0,0.5,849.0,15.0
644137918497,0,0.0,0.5,925.0,0.0
677452337762,0,0.0,,235.0,20.0
649286254416,0,0.0,0.4,521.0,13.0
678155773601,0,0.0,0.4,418.0,16.0
1792836309,0,0.0,0.5,522.0,13.0
666219535353,0,0.0,0.42,551.0,0.0
1722317408,0,0.0,0.5,2525.0,15.0
2139285959,0,0.0,0.5,9699.0,3.0
1069739190,0,0.0,0.5,522.0,13.0
684671938750,0,0.0,0.63,325.0,14.0
662051262760,0,0.0,0.5,399.0,20.0
629376701843,0,0.0,0.42,246.0,1.0
667376780310,0,0.0,0.38,400.0,27.0
669839819133,0,0.0,0.5,238.0,4.0
197968870,0,0.0,0.5,522.0,13.0
1404331918,0,0.0,0.49,522.0,13.0
658095512011,0,0.0,0.5,238.0,4.0
920483328,0,0.0,0.58,320.0,46.0
670844438902,0,0.0,0.66,336.0,44.0
641182127989,0,0.0,0.4,514.0,23.0
666714933900,3,3.3,0.66,233.0,55.0
660905914861,1,1.0,0.64,235.0,54.0
655034180829,0,0.0,0.5,798.0,46.0
623079745967,0,0.0,0.5,4018.0,40.0
631663772854,0,0.0,0.5,4018.0,40.0
640229839193,0,0.0,0.5,2518.0,30.0
637246558920,0,0.0,0.5,4018.0,40.0
635754477794,0,0.0,0.5,4018.0,40.0
631878418187,0,0.0,0.5,4018.0,40.0
680755431176,0,0.0,0.5,2518.0,30.0
622296140399,0,0.0,0.5,4018.0,40.0
620413906218,0,0.0,0.5,4018.0,40.0
683994570764,0,0.0,0.5,2518.0,30.0
620463340964,0,0.0,0.5,4018.0,40.0
635953842826,0,0.0,0.5,4018.0,40.0
644461122791,0,0.0,0.5,980.0,10.0
641647761897,0,0.0,0.5,2518.0,30.0
659911940329,0,0.0,0.5,989.0,10.0
1153393496,3,3.3,0.5,535.0,14.0
90109,7,4.9,0.5,794.0,1.0
600576808,3,2.7,0.5,789.0,12.0
8772032,0,0.0,0.5,593.0,1.0
99423084,0,0.0,0.5,593.0,1.0
819881689,0,0.0,0.5,593.0,1.0
629453478518,0,0.0,,9790.0,55.0
618512595835,0,0.0,0.5,9890.0,52.0
684987200223,0,0.0,,399.0,69.0
682766124447,0,0.0,,399.0,69.0
677440319598,0,0.0,,399.0,69.0
676403227991,0,0.0,0.67,399.0,69.0
684626071200,0,0.0,0.67,399.0,69.0
670684888993,0,0.0,0.6,399.0,60.0
638248378700,0,0.0,0.5,5111.0,0.0